

## Stratification and aggregation factors

Up until now we have considered that the dataset used to fit the volume or biomass model is homogeneous. In reality, the dataset may be drawn from measurements made under different conditions, or may have been generated by merging several separate datasets. Covariables are generally used to describe this dataset heterogeneity. For example, a covariable may indicate the type of forest in which the measurements were made (deciduous, semi-deciduous, evergreen, etc.), the type of soil, or year planted (if a plantation), etc. A crucial covariable for multispecific data is tree species. Initially, all these covariables that can explain the heterogeneity of a dataset were considered as qualitative variables (or factors). The various modalities of these factors define strata, and a well constituted dataset is one that is sampled in relation to previously identified strata (see \S\ \@ref(stratif)). How can these qualitative covariables be taken into account in a volume or biomass model? Is it valid to analyze the dataset in an overall manner? Or should we analyze the data subsets corresponding to each stratum separately? These are the questions we will be addressing here (\S\ \@ref(stdat)).

Also, biomass measurements are made separately for each compartment in the tree (see chapter \@ref(ter)). Therefore, in addition to an estimation of its total biomass, we also have, for each tree in the sample, an estimation of the biomass of its foliage, the biomass of its truck, of its large branches, of its small branches, etc. How can we take account of these different compartments when establishing biomass models? We will also be addressing this question (\S\ \ref{cmpt}).




### Stratifying data {#stdat}

Let us now consider that there are qualitative covariables that stratify the dataset into $S$ strata. As each stratum corresponds to a cross between the modalities of the qualitative covariables (in the context of experimental plans we speak of *treatment* rather than stratum) we will not consider each covariable separately. For example, if one covariable indicates the type of forest with three modalities (let us say: deciduous forest, semi-deciduous forest and evergreen forest) and another covariable indicates the type of soil with three modalities (let us say: sandy soil, clay soil, loamy soil), the cross between these two covariables gives $S=3\times 3=9$ strata (deciduous forest on sandy soil, deciduous forest on clay soil, etc.). We are not looking to analyze the forest type effect separately, or the soil type effect separately. Also, if certain combinations of the covariable modalities are not represented in the dataset, this reduces the number of strata. For example, if there are no evergreen forests on loamy soil, the number of strata $S=8$ instead of 9.

Therefore, when stratifying a dataset, one strategy consists in fitting a model separately for each stratum. In the case of a multiple regression, this would be written:
\[
Y_s=a_{0s}+a_{1s}X_{1s}+a_{2s}X_{2s}+\ldots+a_{ps}X_{ps}+\varepsilon_s
\]
where
\[
\varepsilon_s\mathop{\sim}_{\mathrm{i.i.d.}}\mathcal{N}(0,\ \sigma_s)
\]
where ($Y_s$, $X_{1s}$, \ldots, $X_{ps}$) designates an observation relative to stratum $s$, for $s=1$, \ldots, $S$. There are now $S\times(p+1)$ coefficients to be estimated. An alternative strategy consists in analyzing the dataset as a whole, by fitting a model such as:

\begin{equation}
Y_s=a_{0s}+a_{1s}X_{1s}+a_{2s}X_{2s}+\ldots+a_{ps}X_{ps}+\varepsilon
(\#eq:ancov)
\end{equation}

where
\[
\varepsilon\mathop{\sim}_{\mathrm{i.i.d.}}\mathcal{N}(0,\ \sigma)
\]
This model differs only in the structure of the error. This type of model is called an analysis of *covariance*. It assumes that all the residuals have the same variance, not only within each stratum, but also from one stratum to another. An analysis of covariance can test whether there is a stratum effect on the response variable, alone or in interaction with each of the effect variables $X_1$, \ldots, $X_p$. Testing the main effect of the stratification is equivalent to testing the null hypothesis $a_{01}=a_{02}=\ldots=a_{0S}$. The test statistic is a mean squares ratio which, under the null hypothesis, follows Fisher's distribution. Testing the effect of the interaction between the stratification and the $j$th effect variable is equivalent to testing the null hypothesis $a_{j1}=a_{j2}=\ldots=a_{jS}$. As previously, the test statistic is a mean squares ratio which, under the null hypothesis, follows Fisher's distribution.

The advantage of testing these effects is that each time one proves not to be significant, the $S$ coefficients $a_{j1}$, $a_{j2}$, \ldots, $a_{jS}$ to be estimated can be replaced by a single common coefficient $a_j$. Let us imagine, for example, that in analysis of covariance \@ref(eq:ancov), the main effect of the stratum is not significant, and neither is the interaction between the stratum and the first $p'$ effect variables (where $p'<p$). In this case the model to be fitted is:
\[
Y_s=a_0+a_1X_{1s}+\ldots+a_{p'}X_{p's}+a_{p'+1,s}X_{p'+1,s}+\ldots+a_{ps}X_{ps}+\varepsilon
\]
where $\varepsilon\sim\mathcal{N}(0,\ \sigma)$. This model now includes "only" $p'+1+(p-p')S$ coefficients to be estimated, instead of $(p+1)S$ coefficients if we fit the model separately for each stratum. As all the observations serve to estimate common coefficients $a_0$, \ldots, $a_{p'}$, these are estimated more precisely than if we fit the model separately for each stratum.

This principle of an analysis of covariance can be immediately extended to the case of a non-linear model. Here again, we can test whether or not the coefficients are significantly different between the strata, and if necessary estimate a common coefficient for all the strata.


::::::{.filrouge data-latex=""}

(@eq-fmspe) (ref:mfspe)

:::{.exercise #mfspe name="(ref:mfspe)"}
\  
:::

In red line \@ref(exr:rllnBvD2H), we used simple linear regression to fit a power model with $D^2H$ as effect variable to log-transformed data: $\ln(B)=a+b\ln(D^2H)$. We can now include species-related information in this model to test whether the coefficients $a$ and $b$ differ from one species to another. The model corresponds to an analysis of covariance:
\[
\ln(B_s)=a_s+b_s\ln(D_s^2H_s)+\varepsilon
\]
where
\[
\mathrm{Var}(\varepsilon)=\sigma^2
\]
where index $s$ designates the species. This model is fitted by the command:

```{r, echo=T, results='hide'}
m <- lm(log(Btot) ~ species*I(log(dbh^2*heig)),data=dat[dat$Btot>0,])
```

To test whether the coefficients $a$ and $b$ differ from one species to another, we can use the command:

```{r, echo=T, results='hide'}
anova(m)
```

which yields:

```{r}
printCoefmat(anova(m), signif.legend = FALSE, na.print = "")
```

The first line in the table tests for a species effect, i.e. whether the y-intercept $a_s$ differs from one species to another. The null hypothesis of this test is that there is no difference between species: $a_1=a_2=\ldots=a_S$, where $S=16$ is the number of species. The test statistic is given in the "F value" column. As the p-value of the test is less than 5\ \%, it may be concluded that the y-intercept of the model is significantly different from one species to another. The second line in the table tests for an effect of the $D^2H$, variable, i.e. whether the mean slope associated with this variable is significantly different from zero. The third line in the table tests whether the slope-species interaction is significant, i.e. whether slope $b_s$ differs from one species to another. The null hypothesis is that there is no difference between species: $b_1=b_2=\ldots=b_S$. The p-value here is 0.1785, therefore greater than 5\ \%: there is therefore no significant slope difference between the species.

This leads us to fit the following model:

\begin{equation}
\ln(B_s)=a_s+b\ln(D_s^2H_s)+\varepsilon(\#eq:mspe)
\end{equation}

which considers that slope $b$ is the same for all species. The relevant command is:

```{r, echo=T, results='hide'}
m <- lm(log(Btot) ~ species+I(log(dbh^2*heig)),data=dat[dat$Btot>0,])
anova(m)
```

and yields:

```{r}
printCoefmat(anova(m), signif.legend = F, na.print = "")
```

Model coefficients may be obtained by the command:

```{r, echo=T, results='hide'}
summary(m)
```

which yields:

```{r}
printCoefmat(summary(m)$coef, digits = 4, signif.stars = TRUE, signif.legend = FALSE)
```

The last line in this table gives the value of the slope: $b=0.89985$. The other lines give y-intercept values for the 16 species. By convention, R proceeds in the following manner when specifying these values: the first line in the table gives the y-intercept for the first species in alphabetical order. As the first species in alphabetical order is *Afzelia bella*, the y-intercept for *Afzelia bella* is therefore $a_1=-9.00359$. The subsequent lines give the *difference* $a_s-a_1$ between the y-intercepts of the species indicated and the y-intercept of *Afzelia bella*. Thus, the y-intercept of *Aubrevillea kerstingii* is: $a_2=a_1-0.54634=-9.00359-0.54634=-9.54993$. Finally, the expression for the specific table corresponds to:
\[
\ln(B)=0.89985\ln(D^2H)-\left\{
\begin{array}{lcl}
9.00359 && \textrm{for } \textit{Afzelia bella}   \\ %
9.54993 && \textrm{for } \textit{Aubrevillea kerstingii}   \\ %
9.78047 && \textrm{for } \textit{Cecropia peltata}         \\ %
9.71200 && \textrm{for } \textit{Ceiba pentandra}          \\ %
9.46786 && \textrm{for } \textit{Cola nitida}              \\ %
8.95674 && \textrm{for } \textit{Daniellia thurifera}      \\ %
9.15985 && \textrm{for } \textit{Dialium aubrevilliei}     \\ %
8.95406 && \textrm{for } \textit{Drypetes chevalieri}      \\ %
7.90713 && \textrm{for } \textit{Garcinia epunctata}       \\ %
9.45614 && \textrm{for } \textit{Guarea cedrata}           \\ %
9.27223 && \textrm{for } \textit{Heritiera utilis}         \\ %
9.55823 && \textrm{for } \textit{Nauclea diderrichii}      \\ %
9.48176 && \textrm{for } \textit{Nesogordonia papaverifera}\\ %
9.18315 && \textrm{for } \textit{Piptadeniastrum africanum}\\ %
8.94026 && \textrm{for } \textit{Strombosia glaucescens}   \\ %
9.09462 && \textrm{for } \textit{Tieghemella heckelii}     \\ %
\end{array}
\right.
\]

For a given diameter and height, the species with the highest biomass is *Garcinia epunctata* while that with the lowest biomass is *Cecropia peltata*. The model's residual standard deviation is $\hat{\sigma}=0.3093$ and $R^2=0.9901$.

::::::


#### Case of a numerical covariable {-}









